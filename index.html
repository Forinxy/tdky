<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>HTML å·¥å…·ç®± Pro</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  :root{
    --primary:#6366f1;--primary-dark:#4f46e5;
    --secondary:#22c55e;--warning:#f59e0b;--danger:#ef4444;
    --bg:#0b1224;--bg2:#0f172a;--card:#121c33;--card2:#0f1a31;
    --input:#0b1224;
    --text:#eef2ff;--muted:#9aa7c0;
    --border:#23304a;
    --shadow: 0 20px 70px rgba(0,0,0,.45);
    --shadow2: 0 10px 40px rgba(0,0,0,.35);
    --radius:16px;
  }
  body{
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "PingFang SC","Microsoft YaHei",sans-serif;
    background:
      radial-gradient(1000px 600px at 20% 10%, rgba(99,102,241,.18), transparent 60%),
      radial-gradient(900px 600px at 80% 0%, rgba(236,72,153,.10), transparent 60%),
      radial-gradient(900px 700px at 70% 90%, rgba(34,197,94,.10), transparent 60%),
      linear-gradient(180deg, var(--bg), var(--bg2));
    color:var(--text);
    min-height:100vh;
    padding:20px;
  }
  .container{max-width:1500px;margin:0 auto}
  .header{
    position:relative;
    padding:28px 26px;
    border:1px solid var(--border);
    border-radius: calc(var(--radius) + 6px);
    background: linear-gradient(135deg, rgba(99,102,241,.12), rgba(168,85,247,.10), rgba(236,72,153,.08));
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .header::before{
    content:"";
    position:absolute;inset:-1px;
    background:
      radial-gradient(circle at 20% 20%, rgba(255,255,255,.12), transparent 35%),
      radial-gradient(circle at 80% 0%, rgba(255,255,255,.08), transparent 30%);
    pointer-events:none;
  }
  .title-row{display:flex;gap:14px;align-items:center;justify-content:space-between;position:relative}
  .title{
    display:flex;gap:14px;align-items:center;
  }
  .logo{
    width:44px;height:44px;border-radius:14px;
    background: linear-gradient(135deg, #6366f1, #a855f7, #ec4899);
    box-shadow: 0 10px 35px rgba(99,102,241,.35);
    display:grid;place-items:center;
    font-weight:800;
  }
  h1{
    font-size:1.65rem;letter-spacing:.2px;line-height:1.1;
  }
  .sub{color:var(--muted);font-size:.95rem;margin-top:6px}
  .header-actions{display:flex;gap:10px;flex-wrap:wrap}
  .pill{
    padding:10px 14px;border-radius:12px;border:1px solid var(--border);
    background: rgba(15,26,49,.55);
    backdrop-filter: blur(8px);
    box-shadow: var(--shadow2);
    display:flex;gap:10px;align-items:center;
    color:var(--muted);
    font-size:.9rem;
  }

  .grid{
    margin-top:18px;
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:16px;
  }
  @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

  .panel{
    border:1px solid var(--border);
    border-radius: var(--radius);
    background: linear-gradient(180deg, rgba(18,28,51,.95), rgba(15,26,49,.92));
    box-shadow: var(--shadow2);
    overflow:hidden;
    display:flex;flex-direction:column;
    min-height:520px;
  }
  .panel-header{
    padding:14px 16px;
    border-bottom:1px solid var(--border);
    display:flex;justify-content:space-between;align-items:center;gap:12px;
    background: linear-gradient(135deg, rgba(99,102,241,.13), rgba(34,197,94,.06));
  }
  .panel-title{
    display:flex;gap:10px;align-items:center;
    font-weight:700;
  }
  .badge{
    font-size:.78rem;
    padding:4px 10px;border-radius:999px;
    border:1px solid rgba(255,255,255,.08);
    background: rgba(11,18,36,.55);
    color:var(--muted);
  }
  .stats{
    display:flex;gap:10px;flex-wrap:wrap;
    color:var(--muted);font-size:.86rem;
  }
  .stat b{color:#c7d2fe}
  .panel-body{padding:14px;display:flex;flex-direction:column;gap:12px;flex:1}
  textarea{
    width:100%;flex:1;min-height:340px;
    background: rgba(11,18,36,.95);
    border:1px solid var(--border);
    border-radius: 14px;
    padding:14px 14px;
    color:var(--text);
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Fira Code", monospace;
    font-size:13px;line-height:1.6;
    resize:vertical;
    outline:none;
    transition:.2s ease;
  }
  textarea:focus{
    border-color: rgba(99,102,241,.9);
    box-shadow: 0 0 0 4px rgba(99,102,241,.18);
  }
  .mini-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .mini-row .left, .mini-row .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .input{
    height:38px;min-width:220px;
    border-radius:12px;
    background: rgba(11,18,36,.95);
    border:1px solid var(--border);
    color:var(--text);
    padding:0 12px;
    outline:none;
  }
  .input::placeholder{color: #7f8aa3}

  .toolbar{
    margin-top:16px;
    border:1px solid var(--border);
    border-radius: var(--radius);
    background: linear-gradient(180deg, rgba(18,28,51,.92), rgba(15,26,49,.88));
    box-shadow: var(--shadow2);
    overflow:hidden;
  }
  .toolbar-top{
    padding:14px 16px;
    display:flex;justify-content:space-between;align-items:center;gap:12px;
    border-bottom:1px solid var(--border);
    background: linear-gradient(135deg, rgba(236,72,153,.10), rgba(99,102,241,.10));
  }
  .toolbar-title{font-weight:800}
  .toolbar-body{padding:14px 16px;display:grid;gap:14px}
  .section{
    border:1px solid rgba(255,255,255,.06);
    background: rgba(11,18,36,.35);
    border-radius: 14px;
    padding:12px;
  }
  .section-label{
    color:var(--muted);
    font-size:.82rem;
    text-transform:uppercase;
    letter-spacing:.9px;
    font-weight:800;
    margin-bottom:10px;
  }
  .btns{display:flex;gap:10px;flex-wrap:wrap}

  .btn{
    border:none;cursor:pointer;
    padding:11px 14px;
    border-radius: 12px;
    color:white;
    font-weight:800;
    display:flex;gap:8px;align-items:center;
    transition: transform .12s ease, box-shadow .2s ease, filter .2s ease;
    position:relative;overflow:hidden;
    user-select:none;
  }
  .btn:active{transform: translateY(1px)}
  .btn:hover{filter:brightness(1.05)}
  .btn::before{
    content:"";
    position:absolute;inset:0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);
    transform: translateX(-120%);
    transition: .55s;
  }
  .btn:hover::before{transform: translateX(120%)}
  .b-primary{background: linear-gradient(135deg, #6366f1, #8b5cf6); box-shadow: 0 12px 30px rgba(99,102,241,.25)}
  .b-green{background: linear-gradient(135deg, #22c55e, #16a34a); box-shadow: 0 12px 30px rgba(34,197,94,.22)}
  .b-orange{background: linear-gradient(135deg, #f59e0b, #d97706); box-shadow: 0 12px 30px rgba(245,158,11,.22)}
  .b-gray{background: linear-gradient(135deg, #64748b, #475569); box-shadow: 0 12px 30px rgba(100,116,139,.20)}
  .b-red{background: linear-gradient(135deg, #ef4444, #dc2626); box-shadow: 0 12px 30px rgba(239,68,68,.22)}
  .b-sky{background: linear-gradient(135deg, #0ea5e9, #0284c7); box-shadow: 0 12px 30px rgba(14,165,233,.22)}
  .b-purple{background: linear-gradient(135deg, #a855f7, #6366f1); box-shadow: 0 12px 30px rgba(168,85,247,.22)}

  .toggle{
    display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    color:var(--muted);font-size:.92rem;
  }
  .toggle input{width:18px;height:18px;accent-color: var(--primary);cursor:pointer}
  .chips{display:flex;gap:10px;flex-wrap:wrap}
  .chip{
    padding:8px 12px;border-radius: 12px;
    background: rgba(11,18,36,.85);
    border:1px solid var(--border);
    cursor:pointer;
    color: var(--muted);
    font-weight:800;
    font-size:.86rem;
    transition: .2s ease;
  }
  .chip:hover{border-color: rgba(245,158,11,.8); color:#ffd08a}
  .chip.active{border-color: rgba(245,158,11,.9); background: rgba(245,158,11,.12); color:#ffd08a}

  .info{
    display:none;
    padding:12px;
    border-radius: 14px;
    border:1px solid rgba(255,255,255,.06);
    background: rgba(11,18,36,.55);
  }
  .info.show{display:block}
  .bar{height:10px;border-radius:999px;background: rgba(255,255,255,.07);overflow:hidden;margin-top:10px}
  .bar > div{height:100%;width:0%;transition: width .5s ease;background: linear-gradient(90deg, var(--secondary), var(--primary))}
  .info-row{display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:.9rem}
  .info-row b{color:#bbf7d0}

  .toast{
    position:fixed;right:18px;bottom:18px;
    padding:12px 14px;
    border-radius: 14px;
    background: rgba(18,28,51,.95);
    border:1px solid var(--border);
    box-shadow: var(--shadow2);
    transform: translateY(20px);
    opacity:0;
    transition:.25s ease;
    z-index:2000;
    max-width:min(520px, calc(100vw - 40px));
  }
  .toast.show{opacity:1;transform: translateY(0)}
  .toast.success{border-color: rgba(34,197,94,.45)}
  .toast.error{border-color: rgba(239,68,68,.55)}
  .toast small{display:block;color:var(--muted);margin-top:4px}

  .modal{
    position:fixed;inset:0;
    background: rgba(0,0,0,.72);
    display:none;align-items:center;justify-content:center;
    z-index:1500;
    padding:18px;
  }
  .modal.show{display:flex}
  .modal-card{
    width:min(1100px, 100%);
    height:min(82vh, 900px);
    border-radius: 18px;
    border:1px solid var(--border);
    background: linear-gradient(180deg, rgba(18,28,51,.98), rgba(15,26,49,.95));
    box-shadow: var(--shadow);
    overflow:hidden;
    display:flex;flex-direction:column;
  }
  .modal-head{
    padding:12px 14px;border-bottom:1px solid var(--border);
    display:flex;justify-content:space-between;align-items:center;gap:12px;
  }
  .modal-head .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .modal-head .hint{color:var(--muted);font-size:.9rem}
  .iconbtn{
    height:38px;padding:0 12px;border-radius:12px;border:1px solid var(--border);
    background: rgba(11,18,36,.9);color:var(--text);
    cursor:pointer;
  }
  iframe{flex:1;border:none;background:white}
</style>
</head>

<body>
<div class="container">
  <div class="header">
    <div class="title-row">
      <div>
        <div class="title">
          <div class="logo">H</div>
          <div>
            <h1>HTML å·¥å…·ç®± Pro</h1>
            <div class="sub">å‹ç¼© Â· æ ¼å¼åŒ– Â· æ··æ·† Â· æŸ¥æ‰¾æ›¿æ¢ Â· å¯¼å…¥å¯¼å‡º Â· é¢„è§ˆ</div>
          </div>
        </div>
      </div>
      <div class="header-actions">
        <div class="pill" title="å®æ—¶ç»Ÿè®¡">
          <span>è¾“å…¥</span><b id="hIn">0</b><span>å­—ç¬¦</span>
          <span style="opacity:.5">|</span>
          <span>è¾“å‡º</span><b id="hOut">0</b><span>å­—ç¬¦</span>
        </div>
        <div class="pill" title="å¿«æ·æ“ä½œ">
          <span>æ’¤é”€/é‡åšï¼š</span><b>Ctrl+Z / Ctrl+Y</b>
        </div>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">ğŸ“ è¾“å…¥ HTML <span class="badge">æºä»£ç </span></div>
        <div class="stats">
          <span class="stat">è¡Œ <b id="inLines">0</b></span>
          <span class="stat">å­—èŠ‚ <b id="inBytes">0</b></span>
        </div>
      </div>
      <div class="panel-body">
        <div class="mini-row">
          <div class="left">
            <button class="btn b-gray" id="btnImport">ğŸ“‚ å¯¼å…¥æ–‡ä»¶</button>
            <button class="btn b-gray" id="btnPasteDemo">ğŸ§© å¡«å……ç¤ºä¾‹</button>
          </div>
          <div class="right">
            <input class="input" id="findText" placeholder="æŸ¥æ‰¾..." />
            <input class="input" id="replaceText" placeholder="æ›¿æ¢ä¸º..." />
            <button class="btn b-purple" id="btnReplace">ğŸ” æ›¿æ¢å…¨éƒ¨</button>
          </div>
        </div>
        <textarea id="inputHtml" spellcheck="false" placeholder="åœ¨æ­¤ç²˜è´´ HTML..."></textarea>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">âœ¨ è¾“å‡ºç»“æœ <span class="badge">åªè¯»</span></div>
        <div class="stats">
          <span class="stat">è¡Œ <b id="outLines">0</b></span>
          <span class="stat">å­—èŠ‚ <b id="outBytes">0</b></span>
        </div>
      </div>
      <div class="panel-body">
        <div class="mini-row">
          <div class="left">
            <button class="btn b-gray" id="btnSwap">â‡„ äº¤æ¢</button>
            <button class="btn b-gray" id="btnToInput">â¬…ï¸ ç»“æœå†™å›è¾“å…¥</button>
          </div>
          <div class="right">
            <button class="btn b-gray" id="btnCopy">ğŸ“‹ å¤åˆ¶</button>
            <button class="btn b-gray" id="btnDownload">ğŸ’¾ ä¸‹è½½HTML</button>
          </div>
        </div>

        <textarea id="outputHtml" spellcheck="false" readonly placeholder="å¤„ç†åçš„ä»£ç å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>

        <div class="info" id="compressionInfo">
          <div class="info-row">
            <span>å‹ç¼©æ•ˆæœ</span>
            <span><b id="savedPercent">èŠ‚çœ 0%</b></span>
          </div>
          <div class="bar"><div id="compressionBar"></div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toolbar">
    <div class="toolbar-top">
      <div class="toolbar-title">ğŸ§° åŠŸèƒ½é¢æ¿</div>
      <div class="toggle">
        <label style="display:flex;gap:10px;align-items:center;cursor:pointer">
          <input type="checkbox" id="autoRun" />
          è‡ªåŠ¨å®æ—¶å¤„ç†ï¼ˆåŸºäºå½“å‰æ¨¡å¼ï¼‰
        </label>
        <span style="opacity:.4">|</span>
        <span>å½“å‰æ¨¡å¼ï¼š</span><b id="modeLabel">å‹ç¼©</b>
      </div>
    </div>

    <div class="toolbar-body">
      <div class="section">
        <div class="section-label">ä¸»è¦åŠŸèƒ½</div>
        <div class="btns">
          <button class="btn b-primary" id="btnCompress">ğŸ“¦ å‹ç¼©</button>
          <button class="btn b-green" id="btnFormat">âœ¨ æ ¼å¼åŒ–</button>
          <button class="btn b-orange" id="btnObfuscate">ğŸ” æ··æ·†</button>
          <button class="btn b-sky" id="btnPreview">ğŸ‘ï¸ é¢„è§ˆ</button>
          <button class="btn b-red" id="btnClear">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
      </div>

      <div class="section">
        <div class="section-label">å‹ç¼©é€‰é¡¹</div>
        <div class="toggle" style="gap:16px">
          <label style="display:flex;gap:10px;align-items:center;cursor:pointer">
            <input type="checkbox" id="removeComments" checked>ç§»é™¤ HTML æ³¨é‡Š
          </label>
          <label style="display:flex;gap:10px;align-items:center;cursor:pointer">
            <input type="checkbox" id="removeWhitespace" checked>ç§»é™¤å¤šä½™ç©ºç™½
          </label>
          <label style="display:flex;gap:10px;align-items:center;cursor:pointer">
            <input type="checkbox" id="minifyInlineCSS" checked>å‹ç¼©å†…è” CSS
          </label>
          <label style="display:flex;gap:10px;align-items:center;cursor:pointer">
            <input type="checkbox" id="minifyInlineJS" checked>å‹ç¼©å†…è” JS
          </label>
          <label style="display:flex;gap:10px;align-items:center;cursor:pointer">
            <input type="checkbox" id="removeBlankLines" checked>å»é™¤ç©ºè¡Œ
          </label>
        </div>
      </div>

      <div class="section">
        <div class="section-label">æ··æ·†æ–¹å¼</div>
        <div class="chips" id="obfChips">
          <div class="chip active" data-type="base64">Base64 åŒ…è£…</div>
          <div class="chip" data-type="unicode">Unicode è½¬ä¹‰</div>
          <div class="chip" data-type="hex">Hex æ•°ç»„</div>
          <div class="chip" data-type="jsWrite">åˆ†ç‰‡ JS Write</div>
        </div>
        <div class="toggle" style="margin-top:10px">
          <label style="display:flex;gap:10px;align-items:center;cursor:pointer">
            <input type="checkbox" id="obfWrapDoc" checked>è¾“å‡ºåŒ…ä¸€å±‚å®Œæ•´ HTML å£³
          </label>
          <label style="display:flex;gap:10px;align-items:center;cursor:pointer">
            <input type="checkbox" id="obfMinifyFirst" checked>æ··æ·†å‰å…ˆå‹ç¼©
          </label>
        </div>
      </div>

      <div class="section">
        <div class="section-label">å®ç”¨å·¥å…·</div>
        <div class="btns">
          <button class="btn b-gray" id="btnEncodeEntities">ğŸ”¤ å®ä½“ç¼–ç </button>
          <button class="btn b-gray" id="btnDecodeEntities">ğŸ”¡ å®ä½“è§£ç </button>
          <button class="btn b-gray" id="btnRunLink">ğŸ”— ç”Ÿæˆè¿è¡Œé“¾æ¥</button>
          <button class="btn b-gray" id="btnBeautifyAttrs">ğŸ§· å±æ€§æ•´ç†</button>
        </div>
        <small style="display:block;color:var(--muted);margin-top:10px;line-height:1.4">
          å±æ€§æ•´ç†ï¼šä»…åšè½»é‡è§„åˆ™ï¼ˆå»é‡å¤ç©ºæ ¼ã€å±æ€§ä¹‹é—´å•ç©ºæ ¼ã€å¼•å·è§„èŒƒï¼‰ï¼Œä¸ä¼šâ€œå®Œå…¨ç†è§£â€HTMLè¯­æ³•æ ‘ã€‚
        </small>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<div class="modal" id="previewModal">
  <div class="modal-card">
    <div class="modal-head">
      <div><b>ğŸ‘ï¸ é¢„è§ˆ</b> <span class="hint">æç¤ºï¼šé¢„è§ˆä¼šæ‰§è¡Œè„šæœ¬ï¼Œè¯·ä»…é¢„è§ˆä½ ä¿¡ä»»çš„ä»£ç ã€‚</span></div>
      <div class="right">
        <button class="iconbtn" id="btnOpenNew">æ–°çª—å£æ‰“å¼€</button>
        <button class="iconbtn" id="btnClosePreview">å…³é—­</button>
      </div>
    </div>
    <iframe id="previewFrame" sandbox="allow-scripts allow-forms allow-popups allow-modals allow-same-origin"></iframe>
  </div>
</div>

<input type="file" id="fileInput" accept=".html,.htm,.txt" hidden />

<script>
/** -------------------------
 *  çŠ¶æ€ä¸å°å·¥å…·
 * --------------------------*/
let currentMode = 'compress'; // compress | format | obfuscate
let currentObf = 'base64';
const history = { stack: [], idx: -1, lock: false };

const $ = (id) => document.getElementById(id);
const inputEl = $('inputHtml');
const outputEl = $('outputHtml');

function bytesOf(str){ return new Blob([str]).size; }
function linesOf(str){ return str.length ? str.split('\n').length : 0; }

function toast(msg, type='success', detail=''){
  const t = $('toast');
  t.className = 'toast ' + type;
  t.innerHTML = `<div>${type==='success'?'âœ…':'âŒ'} ${escapeHtml(msg)}${detail?`<small>${escapeHtml(detail)}</small>`:''}</div>`;
  requestAnimationFrame(()=>t.classList.add('show'));
  setTimeout(()=>t.classList.remove('show'), 2600);
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function setMode(mode){
  currentMode = mode;
  $('modeLabel').textContent = mode==='compress'?'å‹ç¼©':mode==='format'?'æ ¼å¼åŒ–':'æ··æ·†';
}

function updateStats(){
  const inV = inputEl.value;
  const outV = outputEl.value;
  $('hIn').textContent = inV.length;
  $('hOut').textContent = outV.length;
  $('inLines').textContent = linesOf(inV);
  $('outLines').textContent = linesOf(outV);
  $('inBytes').textContent = bytesOf(inV);
  $('outBytes').textContent = bytesOf(outV);
}

function pushHistory(){
  if(history.lock) return;
  const v = inputEl.value;
  const last = history.stack[history.idx];
  if(last === v) return;
  history.stack = history.stack.slice(0, history.idx + 1);
  history.stack.push(v);
  history.idx = history.stack.length - 1;
}

/** ç®€åŒ–æ’¤é”€/é‡åšï¼šåªé’ˆå¯¹ input */
function undo(){
  if(history.idx <= 0) return;
  history.lock = true;
  history.idx--;
  inputEl.value = history.stack[history.idx] ?? '';
  history.lock = false;
  runAuto();
  updateStats();
}
function redo(){
  if(history.idx >= history.stack.length - 1) return;
  history.lock = true;
  history.idx++;
  inputEl.value = history.stack[history.idx] ?? '';
  history.lock = false;
  runAuto();
  updateStats();
}

inputEl.addEventListener('input', () => { pushHistory(); runAuto(); updateStats(); });
window.addEventListener('load', () => { pushHistory(); updateStats(); });

document.addEventListener('keydown', (e)=>{
  if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='z'){ e.preventDefault(); undo(); }
  if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='y'){ e.preventDefault(); redo(); }
});

/** -------------------------
 *  æ ¸å¿ƒï¼šå‹ç¼© / æ ¼å¼åŒ– / æ··æ·†
 * --------------------------*/
function compressHTML(raw){
  let result = raw;
  const removeComments = $('removeComments').checked;
  const removeWhitespace = $('removeWhitespace').checked;
  const minifyCSS = $('minifyInlineCSS').checked;
  const minifyJS = $('minifyInlineJS').checked;
  const removeBlankLines = $('removeBlankLines').checked;

  // 1) ç§»é™¤ HTML æ³¨é‡Šï¼ˆä¿®å¤ä½ åŸæ¥çš„æ­£åˆ™ bugï¼‰
  // æ³¨æ„ï¼šä¸åšâ€œæ¡ä»¶æ³¨é‡Šâ€ç­‰é«˜çº§å…¼å®¹
  if(removeComments){
    result = result.replace(/<!--[\s\S]*?-->/g, '');
  }

  // 2) å†…è” CSS å‹ç¼©ï¼ˆè½»é‡ï¼‰
  if(minifyCSS){
    result = result.replace(/<style\b[^>]*>([\s\S]*?)<\/style>/gi, (m, css) => {
      const min = css
        .replace(/\/\*[\s\S]*?\*\//g,'')
        .replace(/\s+/g,' ')
        .replace(/\s*([{};:,>+~])\s*/g,'$1')
        .replace(/;}/g,'}')
        .trim();
      return m.replace(css, min);
    });
  }

  // 3) å†…è” JS å‹ç¼©ï¼ˆè½»é‡ï¼Œé¿å…ä¼¤å®³å­—ç¬¦ä¸²/æ­£åˆ™çš„æ¦‚ç‡ï¼šåªåšéå¸¸ä¿å®ˆçš„ç©ºç™½å¤„ç†ï¼‰
  if(minifyJS){
    result = result.replace(/<script\b[^>]*>([\s\S]*?)<\/script>/gi, (m, js) => {
      if(/\bsrc\s*=/.test(m)) return m;
      // ä»…ç§»é™¤å—æ³¨é‡Š + è¡Œé¦–å°¾ç©ºç™½ + å¤šç©ºæ ¼ï¼ˆä¸åšè¿ç®—ç¬¦æŒ¤å‹ï¼Œé™ä½è¯¯ä¼¤ï¼‰
      const min = js
        .replace(/\/\*[\s\S]*?\*\//g,'')
        .replace(/^\s+|\s+$/gm,'')
        .replace(/[ \t]{2,}/g,' ')
        .trim();
      return m.replace(js, min);
    });
  }

  // 4) ç©ºè¡Œ/ç©ºç™½
  if(removeBlankLines){
    result = result.replace(/\n\s*\n+/g, '\n');
  }
  if(removeWhitespace){
    result = result
      .replace(/>\s+</g, '><')
      .replace(/[ \t]{2,}/g, ' ')
      .replace(/^\s+|\s+$/gm,'')
      .trim();
  }

  return result;
}

function formatHTML(raw){
  // è½»é‡æ ¼å¼åŒ–ï¼šä¸æ˜¯ä¸¥æ ¼ parserï¼Œä½†æ¯”ä½ åŸæ¥æ›´ç¨³ä¸€ç‚¹
  const voidTags = new Set(['area','base','br','col','embed','hr','img','input','link','meta','param','source','track','wbr']);
  let s = raw.replace(/>\s+</g, '>\n<').trim();
  const lines = s.split('\n').map(l=>l.trim()).filter(Boolean);

  let indent = 0;
  const tab = '  ';
  const out = [];

  for(const line of lines){
    const isClose = /^<\/.+>/.test(line);
    const isOpen = /^<[^/!][^>]*>/.test(line);
    const isSelf = /\/>$/.test(line) || (isOpen && voidTags.has((line.match(/^<([a-zA-Z0-9-]+)/)||[])[1]?.toLowerCase()));

    if(isClose) indent = Math.max(0, indent - 1);
    out.push(tab.repeat(indent) + line);

    // å¼€æ ‡ç­¾ä¸”ä¸æ˜¯è‡ªé—­åˆã€ä¸æ˜¯åŒä¸€è¡Œé—­åˆï¼ˆå¦‚ <div></div>ï¼‰
    if(isOpen && !isSelf && !/<\/[^>]+>\s*$/.test(line)){
      indent++;
    }
  }
  return out.join('\n');
}

function randomHex(n){
  let s=''; for(let i=0;i<n;i++) s += Math.floor(Math.random()*16).toString(16);
  return s;
}

function wrapShell(scriptBody){
  if(!$('obfWrapDoc').checked) return scriptBody;
  return `<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body>${scriptBody}</body></html>`;
}

function obfuscateBase64(html){
  const encoded = btoa(unescape(encodeURIComponent(html)));
  const v = '_0x' + randomHex(6);
  const script = `<script>(function(){var ${v}='${encoded}';document.open();document.write(decodeURIComponent(escape(atob(${v}))));document.close();})();<\/script>`;
  return wrapShell(script);
}
function obfuscateUnicode(html){
  const v = '_0x' + randomHex(6);
  const uni = Array.from(html).map(ch => '\\u' + ch.charCodeAt(0).toString(16).padStart(4,'0')).join('');
  const script = `<script>(function(){var ${v}="${uni}";document.open();document.write(${v});document.close();})();<\/script>`;
  return wrapShell(script);
}
function obfuscateHex(html){
  const a = '_0x' + randomHex(6);
  const s = '_0x' + randomHex(6);
  const arr = Array.from(html).map(ch => '0x' + ch.charCodeAt(0).toString(16)).join(',');
  const script = `<script>(function(){var ${a}=[${arr}],${s}='';for(var i=0;i<${a}.length;i++){${s}+=String.fromCharCode(${a}[i]);}document.open();document.write(${s});document.close();})();<\/script>`;
  return wrapShell(script);
}
function obfuscateJsWrite(html){
  const chunkSize = 60;
  const chunks = [];
  for(let i=0;i<html.length;i+=chunkSize) chunks.push(html.slice(i,i+chunkSize));
  const vars = chunks.map(()=> '_0x'+randomHex(6));
  const decl = chunks.map((c,i)=>{
    const esc = c
      .replace(/\\/g,'\\\\')
      .replace(/'/g,"\\'")
      .replace(/\r/g,'\\r')
      .replace(/\n/g,'\\n')
      .replace(/<\/script>/gi,'<\\/script>');
    return `var ${vars[i]}='${esc}';`;
  }).join('');
  const script = `<script>(function(){${decl}var _r=${vars.join('+')};document.open();document.write(_r);document.close();})();<\/script>`;
  return wrapShell(script);
}

function obfuscateHTML(raw){
  let html = raw;
  if($('obfMinifyFirst').checked){
    html = compressHTML(html);
  }
  switch(currentObf){
    case 'base64': return obfuscateBase64(html);
    case 'unicode': return obfuscateUnicode(html);
    case 'hex': return obfuscateHex(html);
    case 'jsWrite': return obfuscateJsWrite(html);
    default: return obfuscateBase64(html);
  }
}

function showCompression(originalLen, newLen){
  const box = $('compressionInfo');
  const bar = $('compressionBar');
  if(!originalLen){ box.classList.remove('show'); return; }
  const saved = Math.max(0, (1 - (newLen / originalLen)) * 100);
  $('savedPercent').textContent = `èŠ‚çœ ${saved.toFixed(1)}%`;
  bar.style.width = `${Math.min(100, saved).toFixed(1)}%`;
  box.classList.add('show');
}

function run(mode){
  const input = inputEl.value;
  if(!input.trim()){
    outputEl.value = '';
    $('compressionInfo').classList.remove('show');
    updateStats();
    return;
  }
  let out = '';
  if(mode==='compress'){
    out = compressHTML(input);
    outputEl.value = out;
    showCompression(input.length, out.length);
  }else if(mode==='format'){
    out = formatHTML(input);
    outputEl.value = out;
    $('compressionInfo').classList.remove('show');
  }else{
    out = obfuscateHTML(input);
    outputEl.value = out;
    $('compressionInfo').classList.remove('show');
  }
  updateStats();
}

function runAuto(){
  if(!$('autoRun').checked) return;
  run(currentMode);
}

/** -------------------------
 *  å®ç”¨å·¥å…·
 * --------------------------*/
function encodeEntities(str){
  return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function decodeEntities(str){
  const ta = document.createElement('textarea');
  ta.innerHTML = str;
  return ta.value;
}
function tidyAttributes(html){
  // è½»é‡ï¼šæŠŠæ ‡ç­¾å†…éƒ¨å¤šç©ºç™½å‹æˆå•ç©ºæ ¼ï¼Œ= ä¸¤ä¾§å»ç©ºç™½ï¼Œå¼•å·è§„èŒƒä¸å¼ºåˆ¶æ”¹
  return html.replace(/<([a-zA-Z][\w:-]*)(\s+[^>]*?)?>/g, (m, tag, attrs='')=>{
    if(!attrs) return `<${tag}>`;
    let a = attrs
      .replace(/\s+/g,' ')
      .replace(/\s*=\s*/g,'=')
      .trim();
    return `<${tag} ${a}>`;
  });
}

/** -------------------------
 *  äº‹ä»¶ç»‘å®š
 * --------------------------*/
$('btnCompress').addEventListener('click', ()=>{ setMode('compress'); run('compress'); toast('å‹ç¼©å®Œæˆ'); });
$('btnFormat').addEventListener('click', ()=>{ setMode('format'); run('format'); toast('æ ¼å¼åŒ–å®Œæˆ'); });
$('btnObfuscate').addEventListener('click', ()=>{ setMode('obfuscate'); run('obfuscate'); toast('æ··æ·†å®Œæˆ'); });

$('btnClear').addEventListener('click', ()=>{
  inputEl.value=''; outputEl.value='';
  $('compressionInfo').classList.remove('show');
  pushHistory();
  updateStats();
  toast('å·²æ¸…ç©º');
});

$('btnCopy').addEventListener('click', async ()=>{
  const v = outputEl.value;
  if(!v){ toast('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹','error'); return; }
  try{ await navigator.clipboard.writeText(v); toast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'); }
  catch{
    outputEl.select(); document.execCommand('copy');
    toast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
  }
});

$('btnSwap').addEventListener('click', ()=>{
  const a = inputEl.value, b = outputEl.value;
  inputEl.value = b; outputEl.value = a;
  pushHistory();
  updateStats();
  toast('å·²äº¤æ¢è¾“å…¥/è¾“å‡º');
});

$('btnToInput').addEventListener('click', ()=>{
  if(!outputEl.value){ toast('è¾“å‡ºä¸ºç©º','error'); return; }
  inputEl.value = outputEl.value;
  pushHistory();
  runAuto();
  updateStats();
  toast('å·²å°†ç»“æœå†™å›è¾“å…¥');
});

$('btnDownload').addEventListener('click', ()=>{
  const v = outputEl.value || inputEl.value;
  if(!v){ toast('æ²¡æœ‰å¯ä¸‹è½½çš„å†…å®¹','error'); return; }
  const blob = new Blob([v], {type:'text/html;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'output.html';
  document.body.appendChild(a);
  a.click();
  a.remove();
  toast('å·²ç”Ÿæˆä¸‹è½½');
});

$('btnImport').addEventListener('click', ()=> $('fileInput').click());
$('fileInput').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  const text = await f.text();
  inputEl.value = text;
  pushHistory();
  runAuto();
  updateStats();
  toast('å·²å¯¼å…¥æ–‡ä»¶', 'success', f.name);
  e.target.value = '';
});

$('btnPasteDemo').addEventListener('click', ()=>{
  inputEl.value = `<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Demo</title>
  <style>
    body{font-family:system-ui;margin:40px}
    .card{padding:16px;border:1px solid #ddd;border-radius:14px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Hello HTML Toolbox</h1>
    <p>è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ã€‚</p>
    <button onclick="alert('Hi')">Click</button>
  </div>
</body>
</html>`;
  pushHistory();
  runAuto();
  updateStats();
  toast('å·²å¡«å……ç¤ºä¾‹');
});

$('btnReplace').addEventListener('click', ()=>{
  const f = $('findText').value;
  const r = $('replaceText').value;
  if(!f){ toast('è¯·è¾“å…¥æŸ¥æ‰¾å†…å®¹','error'); return; }
  const before = inputEl.value;
  const after = before.split(f).join(r);
  inputEl.value = after;
  pushHistory();
  runAuto();
  updateStats();
  toast('æ›¿æ¢å®Œæˆ', 'success', `æ›¿æ¢ "${f}" -> "${r}"`);
});

document.querySelectorAll('#obfChips .chip').forEach(ch=>{
  ch.addEventListener('click', ()=>{
    document.querySelectorAll('#obfChips .chip').forEach(x=>x.classList.remove('active'));
    ch.classList.add('active');
    currentObf = ch.dataset.type;
    setMode('obfuscate');
    runAuto();
    toast('å·²åˆ‡æ¢æ··æ·†æ–¹å¼', 'success', currentObf);
  });
});

['removeComments','removeWhitespace','minifyInlineCSS','minifyInlineJS','removeBlankLines','obfWrapDoc','obfMinifyFirst','autoRun']
  .forEach(id => $(id).addEventListener('change', ()=>runAuto()));

$('btnEncodeEntities').addEventListener('click', ()=>{
  const v = inputEl.value;
  if(!v.trim()){ toast('è¾“å…¥ä¸ºç©º','error'); return; }
  outputEl.value = encodeEntities(v);
  $('compressionInfo').classList.remove('show');
  updateStats();
  toast('å®ä½“ç¼–ç å®Œæˆ');
});
$('btnDecodeEntities').addEventListener('click', ()=>{
  const v = inputEl.value;
  if(!v.trim()){ toast('è¾“å…¥ä¸ºç©º','error'); return; }
  outputEl.value = decodeEntities(v);
  $('compressionInfo').classList.remove('show');
  updateStats();
  toast('å®ä½“è§£ç å®Œæˆ');
});
$('btnBeautifyAttrs').addEventListener('click', ()=>{
  const v = inputEl.value;
  if(!v.trim()){ toast('è¾“å…¥ä¸ºç©º','error'); return; }
  outputEl.value = tidyAttributes(v);
  $('compressionInfo').classList.remove('show');
  updateStats();
  toast('å±æ€§æ•´ç†å®Œæˆ');
});

$('btnRunLink').addEventListener('click', ()=>{
  const v = outputEl.value || inputEl.value;
  if(!v.trim()){ toast('æ²¡æœ‰å†…å®¹','error'); return; }
  // data URL å¯èƒ½è¾ƒé•¿ï¼Œæµè§ˆå™¨ä¼šé™åˆ¶ï¼›è¿™é‡Œç›´æ¥ç”Ÿæˆé“¾æ¥æ–‡æœ¬ä¾›å¤åˆ¶
  const data = 'data:text/html;charset=utf-8,' + encodeURIComponent(v);
  outputEl.value = data;
  $('compressionInfo').classList.remove('show');
  updateStats();
  toast('å·²ç”Ÿæˆ data è¿è¡Œé“¾æ¥', 'success', 'å¤åˆ¶åç²˜è´´åˆ°æµè§ˆå™¨åœ°å€æ å³å¯ï¼ˆå¯èƒ½å—é•¿åº¦é™åˆ¶ï¼‰');
});

/** é¢„è§ˆ */
$('btnPreview').addEventListener('click', ()=>{
  const v = outputEl.value || inputEl.value;
  if(!v.trim()){ toast('æ²¡æœ‰å¯é¢„è§ˆçš„å†…å®¹','error'); return; }
  $('previewModal').classList.add('show');
  const iframe = $('previewFrame');
  // ç”¨ srcdoc æ›´å¿«ï¼›sandbox å·²æ”¾å¼€è„šæœ¬ç­‰ï¼ˆä»å»ºè®®åªé¢„è§ˆå¯ä¿¡ä»£ç ï¼‰
  iframe.srcdoc = v;
});
$('btnClosePreview').addEventListener('click', closePreview);
$('previewModal').addEventListener('click', (e)=>{ if(e.target.id==='previewModal') closePreview(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closePreview(); });

function closePreview(){
  $('previewModal').classList.remove('show');
  const iframe = $('previewFrame');
  iframe.srcdoc = '';
  iframe.src = 'about:blank';
}

$('btnOpenNew').addEventListener('click', ()=>{
  const v = outputEl.value || inputEl.value;
  if(!v.trim()){ toast('æ²¡æœ‰å†…å®¹','error'); return; }
  const blob = new Blob([v], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  window.open(url, '_blank', 'noopener');
});

/** é»˜è®¤æ¨¡å¼ */
setMode('compress');
updateStats();
</script>
</body>
</html>